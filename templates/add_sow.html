{% extends "base.html" %}

{% block content %}
<h2>Add New SOW</h2>

<form method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <label for="charger_type_id">Charger Type</label>
        <select id="charger_type_id" name="charger_type_id" required>
            <option value="">Select Charger Type...</option>
            {% for charger in charger_types %}
                <option value="{{ charger.id }}">{{ charger.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="customer_id">Customer (Optional)</label>
        <select id="customer_id" name="customer_id">
            <option value="">Select Customer...</option>
            {% for customer in customers %}
                <option value="{{ customer.id }}">{{ customer.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="sow_title">Title</label>
        <input type="text" id="sow_title" name="sow_title" required placeholder="Enter SOW title...">
    </div>

    <div class="form-group">
        <label for="maintenance_scope">Maintenance Scope</label>
        <textarea id="maintenance_scope" name="maintenance_scope" required placeholder="Enter maintenance scope details..."></textarea>
    </div>

    <div class="form-group">
        <label for="parts">Parts</label>
        <textarea id="parts" name="parts" required placeholder="Enter required parts..."></textarea>
    </div>

    <div class="form-group">
        <label for="tools">Tools</label>
        <textarea id="tools" name="tools" required placeholder="Enter required tools..."></textarea>
    </div>

    <div class="form-group">
        <label for="documents">Documents</label>
        <textarea id="documents" name="documents" required placeholder="Enter required documents..."></textarea>
    </div>

    <div class="form-group">
        <label for="service_instructions">Service Instructions</label>
        <textarea id="service_instructions" name="service_instructions" required placeholder="Enter detailed service instructions..."></textarea>
    </div>

    <div class="form-group">
        <label for="sow_images">Upload Images (Optional)</label>
        <input type="file" id="sow_images" name="sow_images" multiple accept="image/*,.pdf" style="margin-bottom: 10px;">
        <small style="color: #666;">Supported formats: PNG, JPG, JPEG, GIF, PDF. Max 16MB per file.</small>
        <div id="image-preview" style="margin-top: 10px;"></div>
        <div id="caption-inputs" style="margin-top: 10px;"></div>
    </div>

    <div class="button-group">
        <button type="submit" class="btn-success">Add SOW</button>
        <button type="reset" class="btn-warning" onclick="clearPreviews()">Clear Form</button>
    </div>
</form>

<script>
let fileArray = [];

// Image preview functionality with captions
document.getElementById('sow_images').addEventListener('change', function(event) {
    const previewDiv = document.getElementById('image-preview');
    const captionDiv = document.getElementById('caption-inputs');
    
    previewDiv.innerHTML = '';
    captionDiv.innerHTML = '';
    fileArray = Array.from(event.target.files);
    
    if (fileArray.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'Images to Upload:';
        header.style.marginBottom = '10px';
        previewDiv.appendChild(header);
        
        const captionHeader = document.createElement('h4');
        captionHeader.textContent = 'Image Captions (Optional):';
        captionHeader.style.marginBottom = '10px';
        captionDiv.appendChild(captionHeader);
    }
    
    fileArray.forEach((file, index) => {
        // Create preview
        const container = document.createElement('div');
        container.style.display = 'inline-block';
        container.style.margin = '5px';
        container.style.textAlign = 'center';
        container.style.position = 'relative';
        
        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = '200px';
            img.style.maxHeight = '150px';
            img.style.border = '1px solid #ddd';
            img.style.borderRadius = '4px';
            container.appendChild(img);
        } else {
            const fileDiv = document.createElement('div');
            fileDiv.textContent = `ðŸ“„ ${file.name}`;
            fileDiv.style.padding = '20px';
            fileDiv.style.border = '1px solid #ddd';
            fileDiv.style.borderRadius = '4px';
            fileDiv.style.backgroundColor = '#f9f9f9';
            fileDiv.style.minWidth = '150px';
            container.appendChild(fileDiv);
        }
        
        const fileName = document.createElement('div');
        fileName.textContent = file.name;
        fileName.style.fontSize = '12px';
        fileName.style.marginTop = '5px';
        fileName.style.color = '#666';
        fileName.style.wordBreak = 'break-word';
        container.appendChild(fileName);
        
        previewDiv.appendChild(container);
        
        // Create caption input
        const captionContainer = document.createElement('div');
        captionContainer.style.marginBottom = '10px';
        captionContainer.style.padding = '10px';
        captionContainer.style.border = '1px solid #ddd';
        captionContainer.style.borderRadius = '4px';
        captionContainer.style.backgroundColor = '#f9f9f9';
        
        const captionLabel = document.createElement('label');
        captionLabel.textContent = `Caption for: ${file.name}`;
        captionLabel.style.display = 'block';
        captionLabel.style.fontWeight = 'bold';
        captionLabel.style.marginBottom = '5px';
        
        const captionInput = document.createElement('input');
        captionInput.type = 'text';
        captionInput.name = 'captions';
        captionInput.placeholder = 'Enter caption for this image...';
        captionInput.style.width = '100%';
        captionInput.style.padding = '8px';
        captionInput.style.border = '1px solid #ccc';
        captionInput.style.borderRadius = '4px';
        
        captionContainer.appendChild(captionLabel);
        captionContainer.appendChild(captionInput);
        captionDiv.appendChild(captionContainer);
    });
});

function clearPreviews() {
    document.getElementById('image-preview').innerHTML = '';
    document.getElementById('caption-inputs').innerHTML = '';
    fileArray = [];
}
</script>
{% endblock %}
