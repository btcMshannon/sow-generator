{% extends "base.html" %}

{% block content %}
<h2>Edit SOW: {{ sow.title }}</h2>

<form method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <label for="charger_type_id">Charger Type</label>
        <select id="charger_type_id" name="charger_type_id" required>
            {% for charger in charger_types %}
                <option value="{{ charger.id }}" {% if charger.id == sow.charger_type_id %}selected{% endif %}>{{ charger.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="sow_title">Title</label>
        <input type="text" id="sow_title" name="sow_title" value="{{ sow.title }}" required>
    </div>

    <div class="form-group">
        <label for="maintenance_scope">Maintenance Scope</label>
        <textarea id="maintenance_scope" name="maintenance_scope" required>{{ sow.maintenance_scope }}</textarea>
    </div>

    <div class="form-group">
        <label for="parts">Parts</label>
        <textarea id="parts" name="parts" required>{{ sow.parts }}</textarea>
    </div>

    <div class="form-group">
        <label for="tools">Tools</label>
        <textarea id="tools" name="tools" required>{{ sow.tools }}</textarea>
    </div>

    <div class="form-group">
        <label for="documents">Documents</label>
        <textarea id="documents" name="documents" required>{{ sow.documents }}</textarea>
    </div>

    <div class="form-group">
        <label for="service_instructions">Service Instructions</label>
        <textarea id="service_instructions" name="service_instructions" required>{{ sow.service_instructions }}</textarea>
    </div>

    <div class="form-group">
        <label>Current Images</label>
        <div id="current-images" style="margin-bottom: 15px;">
            <!-- Images will be loaded here via JavaScript -->
        </div>
        
        <label for="sow_images">Upload Additional Images</label>
        <input type="file" id="sow_images" name="sow_images" multiple accept="image/*,.pdf" style="margin-bottom: 10px;">
        <small style="color: #666;">Supported formats: PNG, JPG, JPEG, GIF, PDF. Max 16MB per file.</small>
        <div id="image-preview" style="margin-top: 10px;"></div>
    </div>

    <div class="button-group">
        <button type="submit" class="btn-success">Update SOW</button>
        <a href="{{ url_for('edit_sow') }}" class="btn-warning" style="text-decoration: none; padding: 10px 20px; border-radius: 4px; display: inline-block;">Cancel</a>
    </div>
</form>

<script>
const sowId = {{ sow.id }};

// Load existing images
function loadCurrentImages() {
    fetch('/get_sow_images/' + sowId)
        .then(response => response.json())
        .then(images => {
            const currentImagesDiv = document.getElementById('current-images');
            currentImagesDiv.innerHTML = '';
            
            if (images.length === 0) {
                currentImagesDiv.innerHTML = '<p style="color: #666; font-style: italic;">No images uploaded yet.</p>';
                return;
            }
            
            images.forEach(image => {
                const imageContainer = document.createElement('div');
                imageContainer.style.display = 'inline-block';
                imageContainer.style.margin = '10px';
                imageContainer.style.textAlign = 'center';
                imageContainer.style.position = 'relative';
                
                if (image.filename.toLowerCase().endsWith('.pdf')) {
                    const pdfLink = document.createElement('a');
                    pdfLink.href = '/static/uploads/' + image.filename;
                    pdfLink.target = '_blank';
                    pdfLink.textContent = 'ðŸ“„ ' + image.original_filename;
                    pdfLink.style.display = 'block';
                    pdfLink.style.padding = '20px';
                    pdfLink.style.border = '1px solid #ccc';
                    pdfLink.style.borderRadius = '4px';
                    pdfLink.style.textDecoration = 'none';
                    pdfLink.style.backgroundColor = 'white';
                    imageContainer.appendChild(pdfLink);
                } else {
                    const img = document.createElement('img');
                    img.src = '/static/uploads/' + image.filename;
                    img.style.maxWidth = '200px';
                    img.style.maxHeight = '150px';
                    img.style.border = '1px solid #ccc';
                    img.style.borderRadius = '4px';
                    imageContainer.appendChild(img);
                    
                    const caption = document.createElement('div');
                    caption.textContent = image.original_filename;
                    caption.style.fontSize = '12px';
                    caption.style.marginTop = '5px';
                    caption.style.color = '#666';
                    imageContainer.appendChild(caption);
                }
                
                // Add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.textContent = 'Ã—';
                deleteBtn.style.position = 'absolute';
                deleteBtn.style.top = '-5px';
                deleteBtn.style.right = '-5px';
                deleteBtn.style.background = 'red';
                deleteBtn.style.color = 'white';
                deleteBtn.style.border = 'none';
                deleteBtn.style.borderRadius = '50%';
                deleteBtn.style.width = '20px';
                deleteBtn.style.height = '20px';
                deleteBtn.style.cursor = 'pointer';
                deleteBtn.style.fontSize = '14px';
                deleteBtn.onclick = function() {
                    if (confirm('Are you sure you want to delete this image?')) {
                        deleteImage(image.filename);
                    }
                };
                imageContainer.appendChild(deleteBtn);
                
                currentImagesDiv.appendChild(imageContainer);
            });
        })
        .catch(error => {
            console.error('Error loading images:', error);
        });
}

// Delete image
function deleteImage(filename) {
    fetch('/delete_image/' + sowId + '/' + filename, {
        method: 'POST'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            loadCurrentImages(); // Reload the images
        } else {
            alert('Error deleting image');
        }
    })
    .catch(error => {
        console.error('Error deleting image:', error);
        alert('Error deleting image');
    });
}

// Image preview for new uploads
document.getElementById('sow_images').addEventListener('change', function(event) {
    const previewDiv = document.getElementById('image-preview');
    previewDiv.innerHTML = '';
    
    if (event.target.files.length > 0) {
        const header = document.createElement('h4');
        header.textContent = 'New Images to Upload:';
        header.style.marginBottom = '10px';
        previewDiv.appendChild(header);
    }
    
    Array.from(event.target.files).forEach(file => {
        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = '200px';
            img.style.maxHeight = '150px';
            img.style.margin = '5px';
            img.style.border = '1px solid #ddd';
            img.style.borderRadius = '4px';
            previewDiv.appendChild(img);
        } else {
            const fileDiv = document.createElement('div');
            fileDiv.textContent = `ðŸ“„ ${file.name}`;
            fileDiv.style.margin = '5px';
            fileDiv.style.padding = '5px';
            fileDiv.style.border = '1px solid #ddd';
            fileDiv.style.borderRadius = '4px';
            fileDiv.style.display = 'inline-block';
            previewDiv.appendChild(fileDiv);
        }
    });
});

// Load images when page loads
document.addEventListener('DOMContentLoaded', loadCurrentImages);
</script>
{% endblock %}
