{% extends "base.html" %}

{% block content %}
<h2>Edit SOW: {{ sow.title }}</h2>

<form method="POST" enctype="multipart/form-data">
    <div class="form-group">
        <label for="charger_type_id">Charger Type</label>
        <select id="charger_type_id" name="charger_type_id" required>
            {% for charger in charger_types %}
                <option value="{{ charger.id }}" {% if charger.id == sow.charger_type_id %}selected{% endif %}>{{ charger.name }}</option>
            {% endfor %}
        </select>
    </div>

    <div class="form-group">
        <label for="sow_title">Title</label>
        <input type="text" id="sow_title" name="sow_title" value="{{ sow.title }}" required>
    </div>

    <div class="form-group">
        <label for="maintenance_scope">Maintenance Scope</label>
        <textarea id="maintenance_scope" name="maintenance_scope" required>{{ sow.maintenance_scope }}</textarea>
    </div>

    <div class="form-group">
        <label for="parts">Parts</label>
        <textarea id="parts" name="parts" required>{{ sow.parts }}</textarea>
    </div>

    <div class="form-group">
        <label for="tools">Tools</label>
        <textarea id="tools" name="tools" required>{{ sow.tools }}</textarea>
    </div>

    <div class="form-group">
        <label for="documents">Documents</label>
        <textarea id="documents" name="documents" required>{{ sow.documents }}</textarea>
    </div>

    <div class="form-group">
        <label for="service_instructions">Service Instructions</label>
        <textarea id="service_instructions" name="service_instructions" required>{{ sow.service_instructions }}</textarea>
    </div>

    <div class="form-group">
        <label>Current Images</label>
        <div id="current-images" style="margin-bottom: 15px;">
            {% if images %}
                {% for image in images %}
                    <div style="display: inline-block; margin: 10px; text-align: center; position: relative;">
                        {% if image.filename.lower().endswith(('.pdf')) %}
                            <a href="{{ url_for('static', filename='uploads/' + image.filename) }}" target="_blank" style="display: block; padding: 20px; border: 1px solid #ccc; border-radius: 4px; text-decoration: none; background-color: white;">
                                ðŸ“„ {{ image.original_name }}
                            </a>
                        {% else %}
                            <img src="{{ url_for('static', filename='uploads/' + image.filename) }}" style="max-width: 200px; max-height: 150px; border: 1px solid #ccc; border-radius: 4px;">
                        {% endif %}
                        <input type="hidden" name="existing_image_id" value="{{ image.id }}">
                        <input type="text" name="existing_caption" value="{{ image.caption or '' }}" placeholder="Add a caption..." style="width: 100%; box-sizing: border-box; margin-top: 5px;">
                        <button type="button" class="btn-danger" onclick="deleteImage('{{ image.filename }}')" style="position: absolute; top: -5px; right: -5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; font-size: 14px;">&times;</button>
                    </div>
                {% endfor %}
            {% else %}
                <p style="color: #666; font-style: italic;">No images uploaded yet.</p>
            {% endif %}
        </div>
        
        <label for="sow_images">Upload Additional Images</label>
        <input type="file" id="sow_images" name="sow_images" multiple accept="image/*,.pdf" style="margin-bottom: 10px;">
        <small style="color: #666;">Supported formats: PNG, JPG, JPEG, GIF, PDF. Max 16MB per file.</small>
        <div id="image-preview" style="margin-top: 10px;"></div>
        <div id="caption-inputs" style="margin-top: 10px;"></div>
    </div>

    <div class="button-group">
        <button type="submit" class="btn-success">Update SOW</button>
        <a href="{{ url_for('edit_sows') }}" class="btn-warning" style="text-decoration: none; padding: 10px 20px; border-radius: 4px; display: inline-block;">Cancel</a>
    </div>
</form>

<script>
const sowId = {{ sow.id }};

// Image preview for new uploads with caption inputs
document.getElementById('sow_images').addEventListener('change', function(event) {
    const previewDiv = document.getElementById('image-preview');
    const captionDiv = document.getElementById('caption-inputs');
    
    previewDiv.innerHTML = '';
    captionDiv.innerHTML = '';
    
    const files = Array.from(event.target.files);
    
    if (files.length > 0) {
        const previewHeader = document.createElement('h4');
        previewHeader.textContent = 'New Images to Upload:';
        previewHeader.style.marginBottom = '10px';
        previewDiv.appendChild(previewHeader);
        
        const captionHeader = document.createElement('h4');
        captionHeader.textContent = 'Image Captions for New Uploads (Optional):';
        captionHeader.style.marginBottom = '10px';
        captionDiv.appendChild(captionHeader);
    }
    
    files.forEach((file, index) => {
        // Create preview
        const container = document.createElement('div');
        container.style.display = 'inline-block';
        container.style.margin = '5px';
        container.style.textAlign = 'center';
        container.style.position = 'relative';
        
        if (file.type.startsWith('image/')) {
            const img = document.createElement('img');
            img.src = URL.createObjectURL(file);
            img.style.maxWidth = '200px';
            img.style.maxHeight = '150px';
            img.style.border = '1px solid #ddd';
            img.style.borderRadius = '4px';
            container.appendChild(img);
        } else {
            const fileDiv = document.createElement('div');
            fileDiv.textContent = `ðŸ“„ ${file.name}`;
            fileDiv.style.padding = '20px';
            fileDiv.style.border = '1px solid #ddd';
            fileDiv.style.borderRadius = '4px';
            fileDiv.style.backgroundColor = '#f9f9f9';
            fileDiv.style.minWidth = '150px';
            container.appendChild(fileDiv);
        }
        
        const fileName = document.createElement('div');
        fileName.textContent = file.name;
        fileName.style.fontSize = '12px';
        fileName.style.marginTop = '5px';
        fileName.style.color = '#666';
        fileName.style.wordBreak = 'break-word';
        container.appendChild(fileName);
        
        previewDiv.appendChild(container);
        
        // Create caption input
        const captionContainer = document.createElement('div');
        captionContainer.style.marginBottom = '10px';
        captionContainer.style.padding = '10px';
        captionContainer.style.border = '1px solid #ddd';
        captionContainer.style.borderRadius = '4px';
        captionContainer.style.backgroundColor = '#f9f9f9';
        
        const captionLabel = document.createElement('label');
        captionLabel.textContent = `Caption for: ${file.name}`;
        captionLabel.style.display = 'block';
        captionLabel.style.fontWeight = 'bold';
        captionLabel.style.marginBottom = '5px';
        
        const captionInput = document.createElement('input');
        captionInput.type = 'text';
        captionInput.name = 'new_image_captions'; // Corrected name for new captions
        captionInput.placeholder = 'Enter caption for this image...';
        captionInput.style.width = '100%';
        captionInput.style.padding = '8px';
        captionInput.style.border = '1px solid #ccc';
        captionInput.style.borderRadius = '4px';
        
        captionContainer.appendChild(captionLabel);
        captionContainer.appendChild(captionInput);
        captionDiv.appendChild(captionContainer);
    });
});

// Delete image
function deleteImage(filename) {
    if (confirm('Are you sure you want to delete this image?')) {
        fetch('/delete_image/' + sowId + '/' + filename, {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // Reload the page to show the updated image list
            } else {
                alert('Error deleting image');
            }
        })
        .catch(error => {
            console.error('Error deleting image:', error);
            alert('Error deleting image');
        });
    }
}
</script>
{% endblock %}
